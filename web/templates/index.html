<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Celery Pipeline</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.js"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <style>
        .progress-segment {
            transition: background-color 0.3s ease-in-out;
        }
        
        .progress-segment.filled {
            box-shadow: 0 0 4px rgba(34, 197, 94, 0.5);
        }
        
        .progress-segment:hover {
            transform: scale(1.05);
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen py-8">
    <div class="container mx-auto px-4 max-w-4xl" x-data="pipelineApp()">
        <h1 class="text-3xl font-bold text-center mb-8 text-gray-800">–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π Celery Pipeline</h1>
        
        <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞–π–ø–ª–∞–π–Ω–æ–º -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">–ó–∞–ø—É—Å–∫ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ø–∞–π–ø–ª–∞–π–Ω–∞</h2>
            <div class="flex gap-4 items-end">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">–†–∞–∑–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö:</label>
                    <input 
                        type="number" 
                        x-model="dataSize" 
                        class="w-32 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                        min="10" 
                        max="1000"
                    >
                </div>
                <button 
                    @click="startPipeline()" 
                    :disabled="isStarting"
                    class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-md transition-colors disabled:opacity-50"
                    x-text="isStarting ? '–ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è...' : '–ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–∞–π–ø–ª–∞–π–Ω'"
                ></button>
                <button 
                    @click="clearResults()" 
                    class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-md transition-colors"
                >
                    –û—á–∏—Å—Ç–∏—Ç—å
                </button>
            </div>
        </div>
        
        <!-- –°—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="flex items-center">
                <div 
                    class="w-3 h-3 rounded-full mr-3 transition-colors"
                    :class="connection.connected ? 'bg-green-500' : 'bg-red-500'"
                ></div>
                <span class="text-gray-600" x-text="connection.text"></span>
            </div>
        </div>
        
        <!-- –°–µ–≥–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä -->
        <div 
            x-show="progress.visible" 
            x-transition
            class="bg-white rounded-lg shadow-md p-6 mb-6"
        >
            <h2 class="text-xl font-semibold mb-4 text-gray-700">–ü—Ä–æ–≥—Ä–µ—Å—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</h2>
            
            <!-- –û–±—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å —Å —Å–µ–≥–º–µ–Ω—Ç–∞–º–∏ -->
            <div class="mb-4">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-sm font-medium text-gray-700">–û–±—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å</span>
                    <span class="text-sm text-gray-600" x-text="progress.overall + '%'"></span>
                </div>
                <!-- –°–µ–≥–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä -->
                <div class="flex space-x-1 h-6 w-full">
                    <template x-for="segment in progress.overallSegments" :key="segment.id">
                        <div 
                            class="flex-1 h-6 rounded-sm transition-all duration-300 progress-segment"
                            :class="segment.filled ? (progress.overall >= 100 ? 'bg-green-500 filled' : 'bg-blue-500 filled') : 'bg-gray-200'"
                        ></div>
                    </template>
                </div>
            </div>
            
            <!-- –¢–µ–∫—É—â–∏–π —à–∞–≥ —Å —Å–µ–≥–º–µ–Ω—Ç–∞–º–∏ -->
            <div class="mb-4">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-sm font-medium text-gray-700">–¢–µ–∫—É—â–∏–π —à–∞–≥</span>
                    <span class="text-sm text-gray-600" x-text="progress.step + '%'"></span>
                </div>
                <!-- –°–µ–≥–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä –¥–ª—è —à–∞–≥–∞ -->
                <div class="flex space-x-1 h-4 w-full">
                    <template x-for="segment in progress.stepSegments" :key="segment.id">
                        <div 
                            class="flex-1 h-4 rounded-sm transition-all duration-300 progress-segment"
                            :class="segment.filled ? 'bg-green-500 filled' : 'bg-gray-200'"
                        ></div>
                    </template>
                </div>
            </div>
            
            <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã —à–∞–≥–æ–≤ -->
            <div class="flex justify-between items-center mt-6">
                <template x-for="step in progress.steps" :key="step.id">
                    <div class="flex flex-col items-center">
                        <div 
                            class="w-8 h-8 rounded-full flex items-center justify-center text-white font-medium mb-2 transition-colors"
                            :class="getStepClass(step)"
                            x-text="step.completed ? '‚úì' : step.id"
                        ></div>
                        <span class="text-xs text-gray-600 text-center" x-text="step.name"></span>
                    </div>
                    <div 
                        x-show="step.id < 4" 
                        class="flex-1 h-1 bg-gray-300 mx-2"
                    ></div>
                </template>
            </div>
        </div>
        
        <!-- –§–æ—Ä–º–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –≤–≤–æ–¥–∞ -->
        <div 
            x-show="input.visible" 
            x-transition
            class="bg-white rounded-lg shadow-md p-6 mb-6"
        >
            <h2 class="text-xl font-semibold mb-4 text-orange-600">–¢—Ä–µ–±—É–µ—Ç—Å—è –≤–∞—à –≤–≤–æ–¥</h2>
            <div>
                <p class="mb-4 text-gray-700" x-text="input.prompt"></p>
                <div class="mb-4">
                    <!-- Select input -->
                    <select 
                        x-show="input.type === 'select'"
                        x-model="input.value"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500"
                    >
                        <template x-for="option in input.options" :key="option">
                            <option :value="option" x-text="option"></option>
                        </template>
                    </select>
                    
                    <!-- Number input -->
                    <input 
                        x-show="input.type === 'number'"
                        type="number" 
                        x-model="input.value"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500" 
                        placeholder="–í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ"
                    >
                    
                    <!-- Text input -->
                    <input 
                        x-show="input.type === 'text'"
                        type="text" 
                        x-model="input.value"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500" 
                        placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç"
                    >
                </div>
                <button 
                    @click="submitInput()" 
                    :disabled="!input.value || input.submitting"
                    class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-md transition-colors disabled:opacity-50"
                    x-text="input.submitting ? '–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è...' : '–û—Ç–ø—Ä–∞–≤–∏—Ç—å'"
                ></button>
            </div>
        </div>
        
        <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á:</h2>
            <div class="space-y-3">
                <template x-for="result in results" :key="result.id">
                    <div class="p-4 border rounded-lg transition-colors" :class="getResultClass(result.status)">
                        <div class="flex items-start">
                            <span class="text-lg mr-3" x-text="getStatusIcon(result.status)"></span>
                            <div class="flex-1">
                                <div class="flex justify-between items-start">
                                    <strong x-text="result.task_name"></strong>
                                    <span class="text-sm opacity-75" x-text="formatTime(result.timestamp)"></span>
                                </div>
                                <div class="mt-1" x-text="result.result"></div>
                                <div 
                                    x-show="result.error" 
                                    class="mt-2 text-sm opacity-75"
                                    x-text="'–û—à–∏–±–∫–∞: ' + result.error"
                                ></div>
                            </div>
                        </div>
                    </div>
                </template>
                
                <!-- –ó–∞–≥–ª—É—à–∫–∞ –∫–æ–≥–¥–∞ –Ω–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ -->
                <div x-show="results.length === 0" class="text-gray-500 italic">
                    –ó–∞–ø—É—Å—Ç–∏—Ç–µ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –ø–∞–π–ø–ª–∞–π–Ω –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
                </div>
            </div>
        </div>
    </div>

    <script>
        function pipelineApp() {
            return {
                // –û—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                dataSize: 100,
                isStarting: false,
                currentTaskId: null,
                results: [],
                
                // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
                connection: {
                    connected: false,
                    text: '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...'
                },
                
                // –ü—Ä–æ–≥—Ä–µ—Å—Å
                progress: {
                    visible: false,
                    overall: 0,
                    step: 0,
                    currentStep: 1,
                    overallSegments: [],
                    stepSegments: [],
                    steps: [
                        { id: 1, name: '–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞<br>–¥–∞–Ω–Ω—ã—Ö', completed: false, current: false },
                        { id: 2, name: '–û–±—Ä–∞–±–æ—Ç–∫–∞<br>–¥–∞–Ω–Ω—ã—Ö', completed: false, current: false },
                        { id: 3, name: '–ê–Ω–∞–ª–∏–∑<br>–¥–∞–Ω–Ω—ã—Ö', completed: false, current: false },
                        { id: 4, name: '–ì–µ–Ω–µ—Ä–∞—Ü–∏—è<br>–æ—Ç—á–µ—Ç–∞', completed: false, current: false }
                    ]
                },
                
                // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –≤–≤–æ–¥
                input: {
                    visible: false,
                    prompt: '',
                    type: 'text',
                    value: '',
                    options: [],
                    taskId: null,
                    submitting: false
                },
                
                // WebSocket
                socket: null,
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
                init() {
                    this.initializeProgressSegments();
                    this.initializeWebSocket();
                },
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ–≥–º–µ–Ω—Ç–æ–≤ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
                initializeProgressSegments() {
                    this.progress.overallSegments = Array.from({ length: 20 }, (_, i) => ({
                        id: i,
                        filled: false
                    }));
                    
                    this.progress.stepSegments = Array.from({ length: 10 }, (_, i) => ({
                        id: i,
                        filled: false
                    }));
                },
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è WebSocket
                initializeWebSocket() {
                    this.socket = io();
                    
                    this.socket.on('connect', () => {
                        this.connection.connected = true;
                        this.connection.text = '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ';
                    });
                    
                    this.socket.on('disconnect', () => {
                        this.connection.connected = false;
                        this.connection.text = '–û—Ç–∫–ª—é—á–µ–Ω–æ';
                    });
                    
                    this.socket.on('task_update', (data) => {
                        this.handleTaskUpdate(data);
                    });
                },
                
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –∑–∞–¥–∞—á
                handleTaskUpdate(data) {
                    if (data.status === 'input_required') {
                        this.showInputForm(data.request_input);
                    } else {
                        this.hideInputForm();
                    }
                    
                    if (data.progress_info) {
                        this.updateProgress(data.progress_info);
                    }
                    
                    this.addTaskResult(data);
                },
                
                // –ó–∞–ø—É—Å–∫ –ø–∞–π–ø–ª–∞–π–Ω–∞
                async startPipeline() {
                    this.isStarting = true;
                    this.resetProgress();
                    
                    try {
                        const response = await fetch('/start_pipeline', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ data_size: parseInt(this.dataSize) })
                        });
                        
                        const data = await response.json();
                        
                        if (data.success) {
                            this.currentTaskId = data.task_id;
                            this.addTaskResult({
                                task_name: '–°–∏—Å—Ç–µ–º–∞',
                                result: `–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –ø–∞–π–ø–ª–∞–π–Ω –∑–∞–ø—É—â–µ–Ω (ID: ${data.task_id})`,
                                status: 'start',
                                timestamp: new Date().toISOString()
                            });
                        } else {
                            this.addTaskResult({
                                task_name: '–°–∏—Å—Ç–µ–º–∞',
                                result: `–û—à–∏–±–∫–∞: ${data.error}`,
                                status: 'error',
                                timestamp: new Date().toISOString()
                            });
                        }
                    } catch (error) {
                        this.addTaskResult({
                            task_name: '–°–∏—Å—Ç–µ–º–∞',
                            result: `–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞: ${error.message}`,
                            status: 'error',
                            timestamp: new Date().toISOString()
                        });
                    } finally {
                        this.isStarting = false;
                    }
                },
                
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
                updateProgress(progressInfo) {
                    this.progress.visible = true;
                    this.progress.overall = Math.round(progressInfo.overall_progress || 0);
                    this.progress.step = Math.round(progressInfo.step_progress || 0);
                    this.progress.currentStep = progressInfo.current_step || 1;
                    
                    this.updateSegments();
                    this.updateStepIndicators();
                },
                
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ–≥–º–µ–Ω—Ç–æ–≤
                updateSegments() {
                    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–±—â–µ–≥–æ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
                    const overallFilledCount = Math.round((this.progress.overall / 100) * this.progress.overallSegments.length);
                    this.progress.overallSegments.forEach((segment, index) => {
                        segment.filled = index < overallFilledCount;
                    });
                    
                    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ —à–∞–≥–∞
                    const stepFilledCount = Math.round((this.progress.step / 100) * this.progress.stepSegments.length);
                    this.progress.stepSegments.forEach((segment, index) => {
                        segment.filled = index < stepFilledCount;
                    });
                },
                
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤ —à–∞–≥–æ–≤
                updateStepIndicators() {
                    this.progress.steps.forEach(step => {
                        step.completed = step.id < this.progress.currentStep;
                        step.current = step.id === this.progress.currentStep;
                    });
                },
                
                // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã –≤–≤–æ–¥–∞
                showInputForm(inputRequest) {
                    this.input.visible = true;
                    this.input.prompt = inputRequest.prompt;
                    this.input.type = inputRequest.input_type;
                    this.input.options = inputRequest.options || [];
                    this.input.taskId = inputRequest.task_id;
                    this.input.value = inputRequest.input_type === 'select' ? inputRequest.options[0] : '';
                    this.input.submitting = false;
                },
                
                // –°–∫—Ä—ã—Ç–∏–µ —Ñ–æ—Ä–º—ã –≤–≤–æ–¥–∞
                hideInputForm() {
                    this.input.visible = false;
                    this.input.value = '';
                    this.input.submitting = false;
                },
                
                // –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –≤–≤–æ–¥–∞
                async submitInput() {
                    if (!this.input.value || this.input.submitting) return;
                    
                    this.input.submitting = true;
                    
                    try {
                        const response = await fetch('/submit_input', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                task_id: this.input.taskId,
                                input: this.input.value
                            })
                        });
                        
                        const data = await response.json();
                        
                        if (data.success) {
                            this.hideInputForm();
                            this.addTaskResult({
                                task_name: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –≤–≤–æ–¥',
                                result: `–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: ${this.input.value}`,
                                status: 'success',
                                timestamp: new Date().toISOString()
                            });
                        } else {
                            alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤–≤–æ–¥–∞: ' + data.error);
                        }
                    } catch (error) {
                        alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤–≤–æ–¥–∞: ' + error.message);
                    } finally {
                        this.input.submitting = false;
                    }
                },
                
                // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –∑–∞–¥–∞—á–∏
                addTaskResult(data) {
                    const result = {
                        id: Date.now() + Math.random(),
                        task_name: data.task_name,
                        result: data.result,
                        status: data.status,
                        timestamp: data.timestamp,
                        error: data.error
                    };
                    
                    this.results.push(result);
                    
                    // –ê–≤—Ç–æ—Å–∫—Ä–æ–ª–ª –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É
                    this.$nextTick(() => {
                        const lastResult = this.$el.querySelector('.space-y-3 > div:last-child');
                        if (lastResult) {
                            lastResult.scrollIntoView({ behavior: 'smooth' });
                        }
                    });
                },
                
                // –°–±—Ä–æ—Å –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
                resetProgress() {
                    this.progress.overall = 0;
                    this.progress.step = 0;
                    this.progress.currentStep = 1;
                    this.initializeProgressSegments();
                    this.progress.steps.forEach(step => {
                        step.completed = false;
                        step.current = false;
                    });
                },
                
                // –û—á–∏—Å—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
                clearResults() {
                    this.results = [];
                    this.hideInputForm();
                    this.resetProgress();
                    this.progress.visible = false;
                },
                
                // –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–ª–∞—Å—Å–∞ –¥–ª—è —à–∞–≥–∞
                getStepClass(step) {
                    if (step.completed) {
                        return 'bg-green-500';
                    } else if (step.current) {
                        return 'bg-blue-500';
                    } else {
                        return 'bg-gray-300';
                    }
                },
                
                // –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–ª–∞—Å—Å–∞ –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
                getResultClass(status) {
                    const classes = {
                        'start': 'bg-blue-50 border-blue-200 text-blue-800',
                        'progress': 'bg-yellow-50 border-yellow-200 text-yellow-800',
                        'success': 'bg-green-50 border-green-200 text-green-800',
                        'error': 'bg-red-50 border-red-200 text-red-800',
                        'input_required': 'bg-orange-50 border-orange-200 text-orange-800',
                        'completed': 'bg-green-50 border-green-200 text-green-800',
                        'timeout': 'bg-yellow-50 border-yellow-200 text-yellow-800'
                    };
                    
                    return classes[status] || 'bg-gray-50 border-gray-200 text-gray-800';
                },
                
                // –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–∫–æ–Ω–∫–∏ –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞
                getStatusIcon(status) {
                    const icons = {
                        'start': 'üöÄ',
                        'progress': '‚è≥',
                        'success': '‚úÖ',
                        'error': '‚ùå',
                        'input_required': '‚è∏Ô∏è',
                        'completed': 'üéâ',
                        'timeout': '‚è∞'
                    };
                    
                    return icons[status] || '‚ÑπÔ∏è';
                },
                
                // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏
                formatTime(timestamp) {
                    return new Date(timestamp).toLocaleTimeString();
                }
            }
        }
    </script>
</body>
</html>
