<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Celery Pipeline</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.js"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <style>
        .progress-segment {
            transition: background-color 0.3s ease-in-out;
        }
        
        .progress-segment.filled {
            box-shadow: 0 0 4px rgba(34, 197, 94, 0.5);
        }
        
        .progress-segment:hover {
            transform: scale(1.05);
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen py-8">
    <div class="container mx-auto px-4 max-w-4xl" x-data="pipelineApp()">
        <h1 class="text-3xl font-bold text-center mb-8 text-gray-800">Интерактивный Celery Pipeline</h1>
        
        <!-- Управление пайплайном -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">Запуск интерактивного пайплайна</h2>
            <div class="flex gap-4 items-end">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Размер данных:</label>
                    <input 
                        type="number" 
                        x-model="dataSize" 
                        class="w-32 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                        min="10" 
                        max="1000"
                    >
                </div>
                <button 
                    @click="startPipeline()" 
                    :disabled="isStarting"
                    class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-md transition-colors disabled:opacity-50"
                    x-text="isStarting ? 'Запускается...' : 'Запустить пайплайн'"
                ></button>
                <button 
                    @click="clearResults()" 
                    class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-md transition-colors"
                >
                    Очистить
                </button>
            </div>
        </div>
        
        <!-- Статус подключения -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="flex items-center">
                <div 
                    class="w-3 h-3 rounded-full mr-3 transition-colors"
                    :class="connection.connected ? 'bg-green-500' : 'bg-red-500'"
                ></div>
                <span class="text-gray-600" x-text="connection.text"></span>
            </div>
        </div>
        
        <!-- Сегментированный прогресс бар -->
        <div 
            x-show="progress.visible" 
            x-transition
            class="bg-white rounded-lg shadow-md p-6 mb-6"
        >
            <h2 class="text-xl font-semibold mb-4 text-gray-700">Прогресс выполнения</h2>
            
            <!-- Общий прогресс с сегментами -->
            <div class="mb-4">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-sm font-medium text-gray-700">Общий прогресс</span>
                    <span class="text-sm text-gray-600" x-text="progress.overall + '%'"></span>
                </div>
                <!-- Сегментированный прогресс бар -->
                <div class="flex space-x-1 h-6 w-full">
                    <template x-for="segment in progress.overallSegments" :key="segment.id">
                        <div 
                            class="flex-1 h-6 rounded-sm transition-all duration-300 progress-segment"
                            :class="segment.filled ? (progress.overall >= 100 ? 'bg-green-500 filled' : 'bg-blue-500 filled') : 'bg-gray-200'"
                        ></div>
                    </template>
                </div>
            </div>
            
            <!-- Текущий шаг с сегментами -->
            <div class="mb-4">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-sm font-medium text-gray-700">Текущий шаг</span>
                    <span class="text-sm text-gray-600" x-text="progress.step + '%'"></span>
                </div>
                <!-- Сегментированный прогресс бар для шага -->
                <div class="flex space-x-1 h-4 w-full">
                    <template x-for="segment in progress.stepSegments" :key="segment.id">
                        <div 
                            class="flex-1 h-4 rounded-sm transition-all duration-300 progress-segment"
                            :class="segment.filled ? 'bg-green-500 filled' : 'bg-gray-200'"
                        ></div>
                    </template>
                </div>
            </div>
            
            <!-- Индикаторы шагов -->
            <div class="flex justify-between items-center mt-6">
                <template x-for="step in progress.steps" :key="step.id">
                    <div class="flex flex-col items-center">
                        <div 
                            class="w-8 h-8 rounded-full flex items-center justify-center text-white font-medium mb-2 transition-colors"
                            :class="getStepClass(step)"
                            x-text="step.completed ? '✓' : step.id"
                        ></div>
                        <span class="text-xs text-gray-600 text-center" x-text="step.name"></span>
                    </div>
                    <div 
                        x-show="step.id < 4" 
                        class="flex-1 h-1 bg-gray-300 mx-2"
                    ></div>
                </template>
            </div>
        </div>
        
        <!-- Форма пользовательского ввода -->
        <div 
            x-show="input.visible" 
            x-transition
            class="bg-white rounded-lg shadow-md p-6 mb-6"
        >
            <h2 class="text-xl font-semibold mb-4 text-orange-600">Требуется ваш ввод</h2>
            <div>
                <p class="mb-4 text-gray-700" x-text="input.prompt"></p>
                <div class="mb-4">
                    <!-- Select input -->
                    <select 
                        x-show="input.type === 'select'"
                        x-model="input.value"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500"
                    >
                        <template x-for="option in input.options" :key="option">
                            <option :value="option" x-text="option"></option>
                        </template>
                    </select>
                    
                    <!-- Number input -->
                    <input 
                        x-show="input.type === 'number'"
                        type="number" 
                        x-model="input.value"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500" 
                        placeholder="Введите число"
                    >
                    
                    <!-- Text input -->
                    <input 
                        x-show="input.type === 'text'"
                        type="text" 
                        x-model="input.value"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500" 
                        placeholder="Введите текст"
                    >
                </div>
                <button 
                    @click="submitInput()" 
                    :disabled="!input.value || input.submitting"
                    class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-md transition-colors disabled:opacity-50"
                    x-text="input.submitting ? 'Отправляется...' : 'Отправить'"
                ></button>
            </div>
        </div>
        
        <!-- Результаты выполнения -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">Результаты выполнения задач:</h2>
            <div class="space-y-3">
                <template x-for="result in results" :key="result.id">
                    <div class="p-4 border rounded-lg transition-colors" :class="getResultClass(result.status)">
                        <div class="flex items-start">
                            <span class="text-lg mr-3" x-text="getStatusIcon(result.status)"></span>
                            <div class="flex-1">
                                <div class="flex justify-between items-start">
                                    <strong x-text="result.task_name"></strong>
                                    <span class="text-sm opacity-75" x-text="formatTime(result.timestamp)"></span>
                                </div>
                                <div class="mt-1" x-text="result.result"></div>
                                <div 
                                    x-show="result.error" 
                                    class="mt-2 text-sm opacity-75"
                                    x-text="'Ошибка: ' + result.error"
                                ></div>
                            </div>
                        </div>
                    </div>
                </template>
                
                <!-- Заглушка когда нет результатов -->
                <div x-show="results.length === 0" class="text-gray-500 italic">
                    Запустите интерактивный пайплайн для просмотра результатов
                </div>
            </div>
        </div>
    </div>

    <script>
        function pipelineApp() {
            return {
                // Основные данные
                dataSize: 100,
                isStarting: false,
                currentTaskId: null,
                results: [],
                
                // Подключение
                connection: {
                    connected: false,
                    text: 'Подключение...'
                },
                
                // Прогресс
                progress: {
                    visible: false,
                    overall: 0,
                    step: 0,
                    currentStep: 1,
                    overallSegments: [],
                    stepSegments: [],
                    steps: [
                        { id: 1, name: 'Подготовка<br>данных', completed: false, current: false },
                        { id: 2, name: 'Обработка<br>данных', completed: false, current: false },
                        { id: 3, name: 'Анализ<br>данных', completed: false, current: false },
                        { id: 4, name: 'Генерация<br>отчета', completed: false, current: false }
                    ]
                },
                
                // Пользовательский ввод
                input: {
                    visible: false,
                    prompt: '',
                    type: 'text',
                    value: '',
                    options: [],
                    taskId: null,
                    submitting: false
                },
                
                // WebSocket
                socket: null,
                
                // Инициализация
                init() {
                    this.initializeProgressSegments();
                    this.initializeWebSocket();
                },
                
                // Инициализация сегментов прогресса
                initializeProgressSegments() {
                    this.progress.overallSegments = Array.from({ length: 20 }, (_, i) => ({
                        id: i,
                        filled: false
                    }));
                    
                    this.progress.stepSegments = Array.from({ length: 10 }, (_, i) => ({
                        id: i,
                        filled: false
                    }));
                },
                
                // Инициализация WebSocket
                initializeWebSocket() {
                    this.socket = io();
                    
                    this.socket.on('connect', () => {
                        this.connection.connected = true;
                        this.connection.text = 'Подключено';
                    });
                    
                    this.socket.on('disconnect', () => {
                        this.connection.connected = false;
                        this.connection.text = 'Отключено';
                    });
                    
                    this.socket.on('task_update', (data) => {
                        this.handleTaskUpdate(data);
                    });
                },
                
                // Обработка обновлений задач
                handleTaskUpdate(data) {
                    if (data.status === 'input_required') {
                        this.showInputForm(data.request_input);
                    } else {
                        this.hideInputForm();
                    }
                    
                    if (data.progress_info) {
                        this.updateProgress(data.progress_info);
                    }
                    
                    this.addTaskResult(data);
                },
                
                // Запуск пайплайна
                async startPipeline() {
                    this.isStarting = true;
                    this.resetProgress();
                    
                    try {
                        const response = await fetch('/start_pipeline', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ data_size: parseInt(this.dataSize) })
                        });
                        
                        const data = await response.json();
                        
                        if (data.success) {
                            this.currentTaskId = data.task_id;
                            this.addTaskResult({
                                task_name: 'Система',
                                result: `Интерактивный пайплайн запущен (ID: ${data.task_id})`,
                                status: 'start',
                                timestamp: new Date().toISOString()
                            });
                        } else {
                            this.addTaskResult({
                                task_name: 'Система',
                                result: `Ошибка: ${data.error}`,
                                status: 'error',
                                timestamp: new Date().toISOString()
                            });
                        }
                    } catch (error) {
                        this.addTaskResult({
                            task_name: 'Система',
                            result: `Ошибка запуска: ${error.message}`,
                            status: 'error',
                            timestamp: new Date().toISOString()
                        });
                    } finally {
                        this.isStarting = false;
                    }
                },
                
                // Обновление прогресса
                updateProgress(progressInfo) {
                    this.progress.visible = true;
                    this.progress.overall = Math.round(progressInfo.overall_progress || 0);
                    this.progress.step = Math.round(progressInfo.step_progress || 0);
                    this.progress.currentStep = progressInfo.current_step || 1;
                    
                    this.updateSegments();
                    this.updateStepIndicators();
                },
                
                // Обновление сегментов
                updateSegments() {
                    // Обновление общего прогресса
                    const overallFilledCount = Math.round((this.progress.overall / 100) * this.progress.overallSegments.length);
                    this.progress.overallSegments.forEach((segment, index) => {
                        segment.filled = index < overallFilledCount;
                    });
                    
                    // Обновление прогресса шага
                    const stepFilledCount = Math.round((this.progress.step / 100) * this.progress.stepSegments.length);
                    this.progress.stepSegments.forEach((segment, index) => {
                        segment.filled = index < stepFilledCount;
                    });
                },
                
                // Обновление индикаторов шагов
                updateStepIndicators() {
                    this.progress.steps.forEach(step => {
                        step.completed = step.id < this.progress.currentStep;
                        step.current = step.id === this.progress.currentStep;
                    });
                },
                
                // Отображение формы ввода
                showInputForm(inputRequest) {
                    this.input.visible = true;
                    this.input.prompt = inputRequest.prompt;
                    this.input.type = inputRequest.input_type;
                    this.input.options = inputRequest.options || [];
                    this.input.taskId = inputRequest.task_id;
                    this.input.value = inputRequest.input_type === 'select' ? inputRequest.options[0] : '';
                    this.input.submitting = false;
                },
                
                // Скрытие формы ввода
                hideInputForm() {
                    this.input.visible = false;
                    this.input.value = '';
                    this.input.submitting = false;
                },
                
                // Отправка пользовательского ввода
                async submitInput() {
                    if (!this.input.value || this.input.submitting) return;
                    
                    this.input.submitting = true;
                    
                    try {
                        const response = await fetch('/submit_input', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                task_id: this.input.taskId,
                                input: this.input.value
                            })
                        });
                        
                        const data = await response.json();
                        
                        if (data.success) {
                            this.hideInputForm();
                            this.addTaskResult({
                                task_name: 'Пользовательский ввод',
                                result: `Отправлено: ${this.input.value}`,
                                status: 'success',
                                timestamp: new Date().toISOString()
                            });
                        } else {
                            alert('Ошибка отправки ввода: ' + data.error);
                        }
                    } catch (error) {
                        alert('Ошибка отправки ввода: ' + error.message);
                    } finally {
                        this.input.submitting = false;
                    }
                },
                
                // Добавление результата задачи
                addTaskResult(data) {
                    const result = {
                        id: Date.now() + Math.random(),
                        task_name: data.task_name,
                        result: data.result,
                        status: data.status,
                        timestamp: data.timestamp,
                        error: data.error
                    };
                    
                    this.results.push(result);
                    
                    // Автоскролл к последнему результату
                    this.$nextTick(() => {
                        const lastResult = this.$el.querySelector('.space-y-3 > div:last-child');
                        if (lastResult) {
                            lastResult.scrollIntoView({ behavior: 'smooth' });
                        }
                    });
                },
                
                // Сброс прогресса
                resetProgress() {
                    this.progress.overall = 0;
                    this.progress.step = 0;
                    this.progress.currentStep = 1;
                    this.initializeProgressSegments();
                    this.progress.steps.forEach(step => {
                        step.completed = false;
                        step.current = false;
                    });
                },
                
                // Очистка результатов
                clearResults() {
                    this.results = [];
                    this.hideInputForm();
                    this.resetProgress();
                    this.progress.visible = false;
                },
                
                // Получение класса для шага
                getStepClass(step) {
                    if (step.completed) {
                        return 'bg-green-500';
                    } else if (step.current) {
                        return 'bg-blue-500';
                    } else {
                        return 'bg-gray-300';
                    }
                },
                
                // Получение класса для результата
                getResultClass(status) {
                    const classes = {
                        'start': 'bg-blue-50 border-blue-200 text-blue-800',
                        'progress': 'bg-yellow-50 border-yellow-200 text-yellow-800',
                        'success': 'bg-green-50 border-green-200 text-green-800',
                        'error': 'bg-red-50 border-red-200 text-red-800',
                        'input_required': 'bg-orange-50 border-orange-200 text-orange-800',
                        'completed': 'bg-green-50 border-green-200 text-green-800',
                        'timeout': 'bg-yellow-50 border-yellow-200 text-yellow-800'
                    };
                    
                    return classes[status] || 'bg-gray-50 border-gray-200 text-gray-800';
                },
                
                // Получение иконки для статуса
                getStatusIcon(status) {
                    const icons = {
                        'start': '🚀',
                        'progress': '⏳',
                        'success': '✅',
                        'error': '❌',
                        'input_required': '⏸️',
                        'completed': '🎉',
                        'timeout': '⏰'
                    };
                    
                    return icons[status] || 'ℹ️';
                },
                
                // Форматирование времени
                formatTime(timestamp) {
                    return new Date(timestamp).toLocaleTimeString();
                }
            }
        }
    </script>
</body>
</html>
